<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stargazing</title>
    <script src="https://unpkg.com/astronomy-engine@latest/astronomy.browser.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #0f172a;
            /* Dark blue/slate background */
            color: #e2e8f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            text-align: center;
            padding: 1rem;
        }

        .container {
            padding: 2rem;
            background: #1e293b;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            max-width: 500px;
            width: 100%;
        }

        h1 {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #38bdf8;
            /* Light blue */
        }

        h2 {
            font-size: 1.2rem;
            color: #94a3b8;
            margin-top: 2rem;
            margin-bottom: 1rem;
            border-bottom: 1px solid #334155;
            padding-bottom: 0.5rem;
        }

        .time-box {
            background: #334155;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }

        .time-label {
            font-size: 0.875rem;
            color: #94a3b8;
            margin-bottom: 0.25rem;
        }

        .time-value {
            font-size: 1.5rem;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
        }

        .data-section {
            margin-top: 1.5rem;
            border-top: 1px solid #334155;
            padding-top: 1.5rem;
        }

        .btn {
            background: #38bdf8;
            color: #0f172a;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn:hover {
            background: #0ea5e9;
        }

        .hidden {
            display: none;
        }

        .solar-event {
            display: flex;
            justify-content: space-between;
            margin: 0.5rem 0;
            font-size: 1.1rem;
        }

        .solar-label {
            color: #94a3b8;
        }

        #error-msg {
            color: #ef4444;
            margin-top: 1rem;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Stargazing</h1>

        <div class="time-box">
            <div class="time-label">Current UTC Time</div>
            <div id="utc-time" class="time-value">Loading...</div>
            <div class="time-label" style="margin-top: 1rem;">Local System Time</div>
            <div id="local-time" class="time-value">Loading...</div>
        </div>

        <div id="initial-state">
            <p style="margin-bottom: 1.5rem; color: #cbd5e1;">Detecting location...</p>
            <button id="locate-btn" class="btn">Use Precise Location</button>
        </div>

        <div id="loading-state" class="hidden">
            <p>Scanning the cosmos...</p>
        </div>

        <div id="data-state" class="hidden data-section">
            <div style="margin-bottom: 1rem; font-size: 0.9rem; color: #94a3b8;">
                Coordinates: <span id="location-coords"></span>
            </div>
            <div id="location-name-container"
                style="margin-bottom: 1rem; font-size: 1.1rem; color: #38bdf8; font-weight: 500;">
                <span id="location-name"></span>
            </div>

            <div class="solar-event">
                <span class="solar-label">ðŸŒ… Sunrise</span>
                <span id="sunrise-time">--:--</span>
            </div>
            <div class="solar-event">
                <span class="solar-label">ðŸŒ‡ Sunset</span>
                <span id="sunset-time">--:--</span>
            </div>
            <div class="solar-event">
                <span class="solar-label">ðŸŒ™ Moon Phase</span>
                <span id="moon-phase">--</span>
            </div>
            <div class="solar-event">
                <span class="solar-label">ðŸŒ‘ Next New Moon</span>
                <span id="next-new-moon">--</span>
            </div>
            <div class="solar-event">
                <span class="solar-label">ðŸŒ• Next Full Moon</span>
                <span id="next-full-moon">--</span>
            </div>
        </div>

        <div id="error-msg" class="hidden"></div>
    </div>

    <script>
        // Update clock every second
        function updateClock() {
            const now = new Date();

            // Helper to format as YYYY-MM-DD HH:MM:SS
            const formatTime = (date, isUTC) => {
                const pad = (n) => n.toString().padStart(2, '0');
                const year = isUTC ? date.getUTCFullYear() : date.getFullYear();
                const month = pad(isUTC ? date.getUTCMonth() + 1 : date.getMonth() + 1);
                const day = pad(isUTC ? date.getUTCDate() : date.getDate());
                const hours = pad(isUTC ? date.getUTCHours() : date.getHours());
                const minutes = pad(isUTC ? date.getUTCMinutes() : date.getMinutes());
                const seconds = pad(isUTC ? date.getUTCSeconds() : date.getSeconds());
                return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
            };

            document.getElementById('utc-time').innerText = formatTime(now, true) + ' UTC';
            document.getElementById('local-time').innerText = formatTime(now, false) + ' Local';
        }
        setInterval(updateClock, 1000);
        updateClock();

        const locateBtn = document.getElementById('locate-btn');
        const initialState = document.getElementById('initial-state');
        const loadingState = document.getElementById('loading-state');
        const dataState = document.getElementById('data-state');
        const errorMsg = document.getElementById('error-msg');

        // Auto-detect location on load
        window.addEventListener('load', () => {
            fetchIPLocation();
        });

        locateBtn.addEventListener('click', () => {
            if (!navigator.geolocation) {
                showError("Geolocation is not supported by your browser.");
                return;
            }

            initialState.classList.add('hidden');
            loadingState.classList.remove('hidden');
            dataState.classList.add('hidden'); // Hide data while re-fetching

            getLoc(true);
        });

        async function fetchIPLocation() {
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();

                if (data.latitude && data.longitude) {
                    success({
                        coords: {
                            latitude: data.latitude,
                            longitude: data.longitude
                        }
                    }, false); // Pass false to indicate this is not precise location
                } else {
                    throw new Error("Invalid IP data");
                }
            } catch (e) {
                console.warn("IP Location failed:", e);
                // Don't show error to user, just stay on initial state waiting for manual click
            }
        }

        function getLoc(highAccuracy) {
            navigator.geolocation.getCurrentPosition(
                (pos) => success(pos, true),
                (err) => {
                    if (highAccuracy) {
                        console.log("High accuracy failed, retrying with low accuracy...");
                        getLoc(false);
                    } else {
                        error(err);
                    }
                },
                {
                    enableHighAccuracy: highAccuracy,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        function success(position, isPrecise) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;

            document.getElementById('location-coords').innerText =
                `${lat.toFixed(4)}, ${lng.toFixed(4)}` + (isPrecise ? " (GPS)" : " (IP)");

            fetchSolarData(lat, lng);
            fetchLocationName(lat, lng);

            const now = new Date();

            if (typeof Astronomy !== 'undefined') {
                updateMoonDetails(now);
            } else {
                console.warn("Astronomy library not loaded yet. Retrying in 500ms...");
                setTimeout(() => {
                    if (typeof Astronomy !== 'undefined') {
                        updateMoonDetails(now);
                    } else {
                        console.error("Astronomy library failed to load.");
                        document.getElementById('moon-phase').innerText = "Lib Error";
                    }
                }, 500);
            }

            // Update UI
            initialState.classList.add('hidden');
            loadingState.classList.add('hidden');
            dataState.classList.remove('hidden');
        }

        function error(err) {
            console.warn(`ERROR(${err.code}): ${err.message}. Falling back to default location.`);
            // Fallback to New Delhi
            success({
                coords: {
                    latitude: 28.6139,
                    longitude: 77.2090
                }
            });
        }

        function showError(msg) {
            errorMsg.innerText = msg;
            errorMsg.classList.remove('hidden');
        }

        async function fetchLocationName(lat, lng) {
            const nameEl = document.getElementById('location-name');
            nameEl.innerText = "Locating city...";

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10&addressdetails=1`);
                const data = await response.json();

                if (data && data.address) {
                    const city = data.address.city || data.address.town || data.address.village || data.address.hamlet || data.address.county;
                    const country = data.address.country;
                    nameEl.innerText = city ? `${city}, ${country}` : data.display_name.split(',')[0];
                } else {
                    nameEl.innerText = "Unknown Location";
                }
            } catch (e) {
                console.error("Reverse geocoding failed", e);
                nameEl.innerText = "";
            }
        }

        async function fetchSolarData(lat, lng) {
            try {
                const response = await fetch(`https://api.sunrise-sunset.org/json?lat=${lat}&lng=${lng}&formatted=0`);
                const data = await response.json();

                if (data.status === 'OK') {
                    const sunrise = new Date(data.results.sunrise);
                    const sunset = new Date(data.results.sunset);

                    document.getElementById('sunrise-time').innerText = sunrise.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    document.getElementById('sunset-time').innerText = sunset.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                    loadingState.classList.add('hidden');
                    dataState.classList.remove('hidden');
                } else {
                    throw new Error('API Error');
                }
            } catch (err) {
                loadingState.classList.add('hidden');
                initialState.classList.remove('hidden');
                showError("Failed to fetch solar data. Please try again.");
                console.error(err);
            }
        }

        function updateMoonDetails(date) {
            // Current Phase
            const phase = Astronomy.MoonPhase(date); // 0..360
            const phaseName = getMoonPhaseName(phase);
            document.getElementById('moon-phase').innerText = phaseName;

            // Next New Moon
            const nextNew = Astronomy.SearchMoonPhase(0, date, 30);
            if (nextNew) {
                document.getElementById('next-new-moon').innerText = nextNew.date.toLocaleDateString();
            }

            // Next Full Moon
            const nextFull = Astronomy.SearchMoonPhase(180, date, 30);
            if (nextFull) {
                document.getElementById('next-full-moon').innerText = nextFull.date.toLocaleDateString();
            }
        }

        function getMoonPhaseName(degrees) {
            if (degrees < 10 || degrees > 350) return "New Moon ðŸŒ‘";
            if (degrees < 80) return "Waxing Crescent ðŸŒ’";
            if (degrees < 100) return "First Quarter ðŸŒ“";
            if (degrees < 170) return "Waxing Gibbous ðŸŒ”";
            if (degrees < 190) return "Full Moon ðŸŒ•";
            if (degrees < 260) return "Waning Gibbous ðŸŒ–";
            if (degrees < 280) return "Last Quarter ðŸŒ—";
            return "Waning Crescent ðŸŒ˜";
        }



    </script>
</body>

</html>